# ShadowSniper - Implementation Plan

## Tech Stack

| Layer | Technology |
|---|---|
| Smart contract | Compact (Midnight's TypeScript-like DSL) |
| DApp / API | TypeScript |
| Operator service | Node.js / TypeScript |
| Web UI | React + Vite |
| Wallet | Midnight Lace wallet |
| Infrastructure | Midnight node, proof server, indexer (Docker) |
| Monorepo | npm workspaces + Turborepo |
| Network | Midnight (L2 on Cardano, currently Kukolu phase) |

## Architecture Decisions

### 1. Single Contract

Cross-contract calls aren't production-ready on Midnight yet. All game logic lives in one Compact contract (`shadow_sniper.compact`). Internally structured with clear separation between round management, betting, RNG, payouts, and configuration.

### 2. RNG: Operator Commit-Reveal

No native on-chain RNG in Compact (ZK circuits must be deterministic). Multi-party commit-reveal has terrible UX (forces every player to submit a second transaction). Our approach:

- Operator commits `hash(secret, roundNumber)` **before** the round opens
- Players bet during the round (single transaction)
- Operator reveals secret after round ends
- Contract verifies and derives random seed: `hash(secret, roundNumber, totalPot)`
- Safety valve: anyone can cancel and refund all bets if operator doesn't resolve within deadline

Upgradeable to ECVRF in a later phase for stronger guarantees.

### 3. Weighted Winner Selection

`fold` over a fixed-size array (`0..MAX_PLAYERS`) with cumulative weight accumulation. `MAX_PLAYERS` is a compile-time constant (e.g., 50) due to Compact's bounded iteration requirement.

### 4. Token Flow

- `receive()` in `placeBet()` accepts NIGHT tokens into contract escrow
- `send()` in `resolveRound()` pays the winner
- House fees accumulate in ledger, withdrawn via `withdrawHouseFees()`
- Progressive pool accumulates in ledger, paid out on jackpot trigger

### 5. Full Transparency

All game data is public (disclosed on-chain). Leaderboards, round history, player profiles, and win streaks are built by indexing on-chain state.

## Project Structure

```
shadow-sniper/
├── contract/                         # Compact smart contract
│   ├── src/
│   │   ├── shadow_sniper.compact     # Core contract source
│   │   └── test/
│   │       └── shadow_sniper.test.ts # Contract unit tests
│   └── managed/                      # Auto-generated by Compact compiler
│
├── api/                              # Shared TypeScript API layer
│   └── src/
│       ├── index.ts                  # Public exports
│       ├── shadow-sniper-api.ts      # Core API class (deploy, join, bet, resolve)
│       ├── types.ts                  # Shared type definitions
│       ├── providers.ts              # Provider factory and config
│       ├── witnesses.ts              # Witness implementations
│       └── utils/
│           ├── rng.ts                # Operator commitment generation
│           └── time.ts               # Round timing helpers
│
├── operator/                         # Automated operator backend
│   └── src/
│       ├── index.ts                  # Service entry point
│       ├── round-manager.ts          # Automated round lifecycle
│       └── config.ts                 # Environment config
│
├── cli/                              # CLI for testing and admin
│   └── src/
│       ├── index.ts                  # CLI entry point
│       └── commands/                 # deploy, bet, status, resolve, etc.
│
├── ui/                               # Player-facing web UI (Phase 4)
│   └── src/
│       ├── App.tsx
│       ├── components/               # RoundDisplay, BetForm, Leaderboard, etc.
│       ├── hooks/                    # useRoundState, usePlaceBet, useWallet
│       └── lib/
│           └── api.ts                # API singleton
│
├── docker/                           # Docker configurations
│   ├── docker-compose.yml            # Full local dev stack
│   └── proof-server.yml              # Proof server config
│
├── DESIGN.md                         # Game design document
├── PLAN.md                           # This file
├── README.md                         # Project overview
├── package.json                      # npm workspaces root
├── turbo.json                        # Turborepo config
└── tsconfig.base.json                # Shared TypeScript config
```

## Implementation Phases

### Phase 1: Scaffold + Core Contract

**Goal**: Deployable contract with basic round lifecycle. No real tokens yet.

1. Set up monorepo with npm workspaces (contract/, api/, cli/, operator/)
2. Install Compact developer tools and Midnight SDK dependencies
3. Write `shadow_sniper.compact`:
   - Ledger state: round config, bets as fixed-size vectors, progressive pool, house balance
   - `constructor()` — set operator public key, initial config
   - `startRound(commitment)` — operator starts round with RNG commitment
   - `placeBet()` — player places bet (tracked in ledger, no real tokens yet)
   - `resolveRound(secret)` — verify commitment, weighted RNG, progressive RNG, determine winners
   - `cancelRound()` — safety valve with timeout
   - `updateConfig()` — operator changes params between rounds
   - `withdrawHouseFees()` — operator withdraws accumulated fees
4. Write contract unit tests
5. Build minimal CLI (deploy, start-round, place-bet, resolve, status)
6. Test on local standalone Docker stack

**Deliverable**: Working game loop on localhost. Bets tracked as ledger values only.

### Phase 2: Token Integration

**Goal**: Real NIGHT token flow through the contract.

- Wire up `receive()` in `placeBet()` for accepting NIGHT tokens
- Wire up `send()` in `resolveRound()` for paying winners
- Implement `withdrawHouseFees()` with `send()` to operator
- Progressive jackpot accumulation and payout
- Test full token lifecycle: wallet -> bet -> win -> wallet
- Handle DUST costs for operator round management

**Deliverable**: Full token lifecycle working on standalone network.

### Phase 3: Operator Service

**Goal**: Hands-off automated round management.

- Automated round lifecycle: start -> wait -> resolve -> start next
- Deterministic secret derivation from master key (per-round secrets)
- Health monitoring and alerting
- Restart/recovery (reconstruct state from on-chain data)
- Configuration hot-reload for bet limits, fees, timing

**Deliverable**: Operator service runs continuously without manual intervention.

### Phase 4: Web UI

**Goal**: Player-facing web application.

- React + Vite app with Midnight Lace wallet integration
- Real-time round display with countdown timer
- Bet placement with amount input
- Player list with bet amounts (live updates)
- Progressive jackpot display
- Round history with past results
- Leaderboards, player profiles, win streaks
- Proof generation loading states (ZK proofs take a few seconds)

**Deliverable**: Full player experience in a web browser.

### Phase 5: Testnet Deployment + Hardening

**Goal**: Production-ready on Midnight preprod testnet.

- Security audit of Compact contract (assertion coverage, token accounting)
- Gas/DUST optimization (minimize circuit size, measure proof times)
- Deploy to preprod testnet
- Faucet integration for testnet NIGHT
- Load testing with concurrent players
- Monitor round resolution reliability
- Analytics and logging in operator service

**Deliverable**: Stable game running on public testnet.

## Edge Cases

| Scenario | Handling |
|---|---|
| 0 players | Round resolves, no payouts, progressive unchanged |
| 1 player | Full refund, no fees charged |
| Operator offline | Anyone cancels after deadline, all bets refunded |
| Wrong secret | Assert fails, transaction reverts |
| Double bet | Assert fails on membership check |
| Late bet | Time constraint rejects transaction |
| Max players | Assert fails, wait for next round |

## Verification Checklist

- [ ] Contract compiles with `compact compile`
- [ ] Unit tests pass
- [ ] Deploy to local standalone stack (Docker)
- [ ] Full round lifecycle via CLI: deploy -> start -> bet -> resolve -> check payouts
- [ ] Single player round: full refund
- [ ] Cancel on timeout: all bets refunded
- [ ] Double bet rejection
- [ ] Progressive jackpot accumulation across rounds
- [ ] Progressive jackpot payout when triggered
- [ ] House fee accumulation and withdrawal
- [ ] Config update between rounds
